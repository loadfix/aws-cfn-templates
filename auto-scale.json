{
        "Parameters": {
            "PublicSubnet1": {
                "Type": "String",
                "Description": "Public Subnet ID in AZ A ",
                "Default": "subnet-79d6b022"
            },
            "PublicSubnet2": {
                "Type": "String",
                "Description": "Public Subnet ID in AZ B ",
                "Default": "subnet-34cfcb1c"
            },
            "PublicSubnet3": {
                "Type": "String",
                "Description": "Private Subnet ID in AZ C ",
                "Default": "subnet-ef5662a6"
            },
            "VPC": {
                "Type": "String",
                "Description": "The VPC ID",
                "Default": "vpc-fce77d9b"
            },
            "AutoScaleAMI": {
                "Type": "String",
                "Description": "WebServer AutoScaleAMI AMZ Linux",
                "Default": "ami-ceafcba8"
            },
            "DomainDNSName": {
                "Type": "String",
                "Default": "my-aws-cloud.com"
            },
            "MaxSize": {
                "Type": "Number",
                "Description": "Maximum number of EC2 instances.",
                "Default": "3"
            },
            "ApplicationName": {
                "Type": "String",
                "Default": "web"
            },
            "AutoScaleInstanceType": {
                "Type": "String",
                "Description": "Type of EC2 instance to launch.",
                "Default": "t2.nano"
            },
            "MinSize": {
                "Type": "Number",
                "Description": "Minimum number of EC2 instances.",
                "Default": "3"
            },
            "KeyName": {
                "Type": "String",
                "Description": "The EC2 Key Pair to allow Remote Desktop access or SSH to the instances.",
                "Default": "openbsd"
            },
            "LinuxSG": {
                "Type": "String",
                "Description": "The security group that allows access to Linux Servers",
                "Default": "sg-60cc3418"
            },
            "LoadBalancerScheme": {
                "Description": "Indicates whether the load balancer in front of the ECS service is internet-facing or internal.",
                "Type": "String",
                "Default": "internet-facing"
            }
        },
        "Description": "CloudFormation template to launch a highly available Web Server stack in Amazon VPC",
        "Resources": {
            "CPUAlarmLow": {
                "Type": "AWS::CloudWatch::Alarm",
                "Properties": {
                    "Statistic": "Average",
                    "Dimensions": [
                        {
                            "Value": {
                                "Ref": "AutoScalingGroup"
                            },
                            "Name": "AutoScalingGroupName"
                        }
                    ],
                    "MetricName": "CPUUtilization",
                    "AlarmActions": [
                        {
                            "Ref": "ScaleDownPolicy"
                        }
                    ],
                    "Period": "60",
                    "Threshold": "10",
                    "AlarmDescription": "Scale-down if CPU < 20% for 2 minutes",
                    "EvaluationPeriods": "2",
                    "Namespace": "AWS/EC2",
                    "ComparisonOperator": "LessThanThreshold"
                }
            },
            "WebDNS": {
                "Properties": {
                    "RecordSets": [
                        {
                            "TTL": "900",
                            "ResourceRecords": [
                                {
                                    "Fn::GetAtt": [
                                        "ELB",
                                        "DNSName"
                                    ]
                                }
                            ],
                            "Type": "CNAME",
                            "Name": {
                                "Fn::Join": [
                                    "",
                                    [
                                        {
                                            "Ref": "ApplicationName"
                                        },
                                        ".",
                                        {
                                            "Ref": "DomainDNSName"
                                        },
                                        "."
                                    ]
                                ]
                            }
                        }
                    ],
                    "HostedZoneName": {
                        "Fn::Join": [
                            "",
                            [
                                {
                                    "Ref": "DomainDNSName"
                                },
                                "."
                            ]
                        ]
                    }
                },
                "Type": "AWS::Route53::RecordSetGroup",
                "DependsOn": "ELB"
            },
            "WaitHandle": {
                "Type": "AWS::CloudFormation::WaitConditionHandle"
            },
            "DefaultTargetGroup": {
                "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
                "Properties": {
                "HealthCheckIntervalSeconds": "15",
                "HealthCheckPath": "/",
                "HealthCheckProtocol": "HTTP",
                "HealthCheckTimeoutSeconds": "10",
                "HealthyThresholdCount": "2",
                "UnhealthyThresholdCount": "2",
                "Matcher": { "HttpCode": "200-299" },
                "Port": "80",
                "Protocol": "HTTP",
                "VpcId": { "Ref": "VPC" }
                }

            },
            "LoadBalancerSecurityGroup": {
                "Type": "AWS::EC2::SecurityGroup",
                "Properties": {
                    "SecurityGroupEgress": [
                        {
                            "FromPort": "80",
                            "IpProtocol": "tcp",
                            "CidrIp": "0.0.0.0/0",
                            "ToPort": "80"
                        },
                        {
                            "FromPort": "443",
                            "IpProtocol": "tcp",
                            "CidrIp": "0.0.0.0/0",
                            "ToPort": "443"
                        },
                        {
                            "FromPort": "8",
                            "IpProtocol": "icmp",
                            "CidrIp": "0.0.0.0/0",
                            "ToPort": "-1"
                        }
                    ],
                    "GroupDescription": "Enable HTTP access on port 80 and 443.",
                    "SecurityGroupIngress": [
                        {
                            "FromPort": "80",
                            "IpProtocol": "tcp",
                            "CidrIp": "0.0.0.0/0",
                            "ToPort": "80"
                        },
                        {
                            "FromPort": "443",
                            "IpProtocol": "tcp",
                            "CidrIp": "0.0.0.0/0",
                            "ToPort": "443"
                        },
                        {
                            "FromPort": "8",
                            "IpProtocol": "icmp",
                            "CidrIp": "0.0.0.0/0",
                            "ToPort": "-1"
                        }
                    ],
                    "VpcId": {
                        "Ref": "VPC"
                    }
                }
            },
            "LaunchConfig": {
                "Type": "AWS::AutoScaling::LaunchConfiguration",
                "Metadata": {
                    "AWS::CloudFormation::Init": {
                        "config": {
                            "services": {
                                "sysvinit": {
                                    "httpd": {
                                        "enabled": "true",
                                        "ensureRunning": "true"
                                    }
                                }
                            },
                            "packages": {
                                "yum": {
                                    "httpd": []
                                }
                            }
                        }
                    }
                },
                "Properties": {
                    "InstanceType": {
                        "Ref": "AutoScaleInstanceType"
                    },
                    "ImageId": {
                        "Ref": "AutoScaleAMI"
                    },
                    "KeyName": {
                        "Ref": "KeyName"
                    },
                    "SecurityGroups": [
                        {
                            "Ref": "AutoScaleSecurityGroup"
                        },
                        {
                            "Ref": "LinuxSG"
                        }
                    ],
                    "UserData": {
                        "Fn::Base64": {
                            "Fn::Join": [
                                "",
                                [
                                    "#!/bin/bash -v\n",
                                    "yum update -y aws-cfn-bootstrap\n",
                                    "# Install software\n",
                                    "/opt/aws/bin/cfn-init -v -s ",
                                    {
                                        "Ref": "AWS::StackName"
                                    },
                                    " -r LaunchConfig ",
                                    " --region ",
                                    {
                                        "Ref": "AWS::Region"
                                    },
                                    "\n",
                                    "# All is well so signal success\n",
                                    "/opt/aws/bin/cfn-signal -e 0 -r \"server setup complete\" '",
                                    {
                                        "Ref": "WaitHandle"
                                    },
                                    "'\n"
                                ]
                            ]
                        }
                    }
                }
            },
            "CPUAlarmHigh": {
                "Type": "AWS::CloudWatch::Alarm",
                "Properties": {
                    "Statistic": "Average",
                    "Dimensions": [
                        {
                            "Value": {
                                "Ref": "AutoScalingGroup"
                            },
                            "Name": "AutoScalingGroupName"
                        }
                    ],
                    "MetricName": "CPUUtilization",
                    "AlarmActions": [
                        {
                            "Ref": "ScaleUpPolicy"
                        }
                    ],
                    "Period": "60",
                    "Threshold": "15",
                    "AlarmDescription": "Scale-up if CPU > 40% for 2 minutes",
                    "EvaluationPeriods": "2",
                    "Namespace": "AWS/EC2",
                    "ComparisonOperator": "GreaterThanThreshold"
                }
            },
            "AutoScalingGroup": {
                "Type": "AWS::AutoScaling::AutoScalingGroup",
                "Properties": {
                    "AvailabilityZones": { "Fn::GetAZs": "" },
                    "VPCZoneIdentifier": [
                        { "Ref": "PublicSubnet1" },
                        { "Ref": "PublicSubnet2" },
                        { "Ref": "PublicSubnet3" }
                    ],
                    "MaxSize": { "Ref": "MaxSize" },
                    "Tags": [
                        {
                            "PropagateAtLaunch": true,
                            "Value": {
                                "Ref": "AWS::StackName"
                            },
                            "Key": "Name"
                        }
                    ],
                    "Cooldown": "300",
                    "HealthCheckType": "ELB",
                    "LaunchConfigurationName": {
                        "Ref": "LaunchConfig"
                    },
                    "MinSize": {
                        "Ref": "MinSize"
                    },
                    "HealthCheckGracePeriod": "3600",
                    "TargetGroupARNs": [ { "Ref": "DefaultTargetGroup" } ]
                }
            },
            "WaitCondition": {
                "Properties": {
                    "Handle": {
                        "Ref": "WaitHandle"
                    },
                    "Timeout": "600"
                },
                "Type": "AWS::CloudFormation::WaitCondition",
                "DependsOn": "AutoScalingGroup"
            },
            "ScaleDownPolicy": {
                "Type": "AWS::AutoScaling::ScalingPolicy",
                "Properties": {
                    "ScalingAdjustment": "-1",
                    "AutoScalingGroupName": {
                        "Ref": "AutoScalingGroup"
                    },
                    "AdjustmentType": "ChangeInCapacity",
                    "Cooldown": "60"
                }
            },
            "ELB": {
                "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
                "Properties": {
                    "Scheme": { "Ref": "LoadBalancerScheme" },
                    "SecurityGroups": [
                        { "Ref": "LoadBalancerSecurityGroup" }
                    ],
                    "Subnets": [
                        { "Ref": "PublicSubnet1" }, 
                        { "Ref": "PublicSubnet2" },
                        { "Ref": "PublicSubnet3" }
                    ]
                }
            },
            "HttpListener": {
                "Type": "AWS::ElasticLoadBalancingV2::Listener",
                "Properties": {
                    "DefaultActions": [{
                        "Type": "forward",
                        "TargetGroupArn": { "Ref": "DefaultTargetGroup" }
                    }],
                    "LoadBalancerArn": { "Ref": "ELB" },
                    "Port": "80",
                    "Protocol": "HTTP"
                }

            },
            "AutoScaleSecurityGroup": {
                "Type": "AWS::EC2::SecurityGroup",
                "Properties": {
                    "GroupDescription": "Enable HTTP access on 80 and 443 from ELB.",
                    "SecurityGroupIngress": [
                        {
                            "FromPort": "80",
                            "IpProtocol": "tcp",
                            "ToPort": "80",
                            "SourceSecurityGroupId": {
                                "Ref": "LoadBalancerSecurityGroup"
                            }
                        },
                        {
                            "FromPort": "443",
                            "IpProtocol": "tcp",
                            "ToPort": "443",
                            "SourceSecurityGroupId": {
                                "Ref": "LoadBalancerSecurityGroup"
                            }
                        }
                    ],
                    "VpcId": {
                        "Ref": "VPC"
                    }
                }
            },
            "ScaleUpPolicy": {
                "Type": "AWS::AutoScaling::ScalingPolicy",
                "Properties": {
                    "ScalingAdjustment": "1",
                    "AutoScalingGroupName": {
                        "Ref": "AutoScalingGroup"
                    },
                    "AdjustmentType": "ChangeInCapacity",
                    "Cooldown": "60"
                }
            }
        },
        "AWSTemplateFormatVersion": "2010-09-09",
        "Outputs": {
            "URL": {
                "Value": {
                    "Fn::Join": [
                        "",
                        [
                            "http://",
                            {
                                "Ref": "ApplicationName"
                            },
                            ".",
                            {
                                "Ref": "DomainDNSName"
                            },
                            "/"
                        ]
                    ]
                },
                "Description": "Full domain"
            },
            "ELBURL": {
                "Value": {
                    "Fn::Join": [
                        "",
                        [
                            "http://",
                            {
                                "Fn::GetAtt": [
                                    "ELB",
                                    "DNSName"
                                ]
                            },
                            "/"
                        ]
                    ]
                },
                "Description": "Web Server URL"
            }
        }
}
